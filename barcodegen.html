<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Layout Composer - Barcode Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --p-width: 210mm; --p-height: 297mm; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #2c3e50; color: #fff; padding: 20px; margin: 0; }
        
        /* Sidebar Composer Controls */
        .composer-sidebar { 
            position: fixed; left: 20px; top: 20px; width: 320px; 
            background: #ffffff; color: #333; padding: 20px; 
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100; max-height: 90vh; overflow-y: auto;
        }

        .field { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: bold; text-transform: uppercase; color: #7f8c8d; margin-bottom: 5px; }
        textarea, input, select { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; box-sizing: border-box; font-family: monospace; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-main { background: #0984e3; color: white; }
        .btn-pdf { background: #d63031; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* The PDF Paper Preview (Canvas) */
        .preview-wrapper { margin-left: 360px; display: flex; justify-content: center; }
        #pdf-composer { 
            width: var(--p-width); 
            min-height: var(--p-height);
            background: white;
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 3 Column Layout */
            align-content: start;
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            color: #000;
        }

        .sticker-cell { 
            border: 0.1mm dashed #ecf0f1; /* Cutting guides */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5mm;
            box-sizing: border-box;
        }

        /* Compressed Barcode Style */
        svg { max-width: 85%; height: auto !important; }

        @media print {
            .composer-sidebar { display: none; }
            body { background: white; padding: 0; }
            .preview-wrapper { margin: 0; }
            #pdf-composer { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

<div class="composer-sidebar">
    <h3 style="margin-top:0; color:#0984e3;">barcode generator</h3>
    
    <div class="field">
        <label>Input Data</label>
        <textarea id="data-input" rows="6"></textarea>
    </div>

    <div class="field">
        <label>Paper Standard</label>
        <select id="paper-size" onchange="adjustPaper()">
            <option value="a4">A4 (210 x 297mm)</option>
            <option value="letter">Letter (216 x 279mm)</option>
        </select>
    </div>

    <div class="field">
        <label>Label Height (mm)</label>
        <input type="number" id="label-height" value="35">
    </div>

    <button class="btn-main" onclick="composeLayout()">Generate</button>
    <button class="btn-pdf" onclick="exportPDF()">Export to PDF</button>
</div>

<div class="preview-wrapper">
    <div id="pdf-composer"></div>
</div>

<script>
    function adjustPaper() {
        const size = document.getElementById('paper-size').value;
        const root = document.querySelector(':root');
        if(size === 'a4') {
            root.style.setProperty('--p-width', '210mm');
            root.style.setProperty('--p-height', '297mm');
        } else {
            root.style.setProperty('--p-width', '215.9mm');
            root.style.setProperty('--p-height', '279.4mm');
        }
    }

    function composeLayout() {
        const input = document.getElementById('data-input').value;
        const h = document.getElementById('label-height').value;
        const composer = document.getElementById('pdf-composer');
        
        const codes = input.split('\n').filter(c => c.trim() !== "");
        composer.innerHTML = ""; 

        codes.forEach((code, i) => {
            const cell = document.createElement('div');
            cell.className = 'sticker-cell';
            cell.style.height = h + "mm";
            
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            const id = `bc-${i}`;
            svg.setAttribute("id", id);
            
            cell.appendChild(svg);
            composer.appendChild(cell);

            JsBarcode(`#${id}`, code, {
                format: "CODE128",
                width: 1.2,
                height: 50,
                displayValue: true,
                font: "Arial",
                fontSize: 14,
                fontOptions: "bold",
                background: "transparent"
            });
        });
    }

    async function exportPDF() {
        const composer = document.getElementById('pdf-composer');
        const stickers = Array.from(document.querySelectorAll('.sticker-cell'));
        
        if (stickers.length === 0) return alert("Compose the layout first!");

        const pdfSize = document.getElementById('paper-size').value;
        const pdf = new jspdf.jsPDF('p', 'mm', pdfSize);
        
        const pw = pdf.internal.pageSize.getWidth();
        const ph = pdf.internal.pageSize.getHeight();

        // Multi-page Calculation
        const labelHeightMm = parseFloat(document.getElementById('label-height').value);
        const paddingOffset = 20; // Accounts for 10mm top/bottom padding
        const rowsPerPage = Math.floor((ph - paddingOffset) / labelHeightMm);
        const stickersPerPage = rowsPerPage * 3; 

        for (let i = 0; i < stickers.length; i += stickersPerPage) {
            if (i > 0) pdf.addPage();

            // Create temporary container for the current page
            const pageContainer = document.createElement('div');
            pageContainer.style.width = getComputedStyle(document.documentElement).getPropertyValue('--p-width');
            pageContainer.style.display = 'grid';
            pageContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
            pageContainer.style.padding = '10mm';
            pageContainer.style.background = 'white';
            pageContainer.style.boxSizing = 'border-box';

            // Add the slice of stickers for this specific page
            const slice = stickers.slice(i, i + stickersPerPage);
            slice.forEach(s => {
                const clone = s.cloneNode(true);
                pageContainer.appendChild(clone);
            });

            // Add a small footer in the PDF layout
            const footer = document.createElement('div');
            footer.style.gridColumn = 'span 3';
            footer.style.textAlign = 'right';
            footer.style.fontSize = '8pt';
            footer.style.color = '#7f8c8d';
            footer.style.paddingTop = '5mm';
            footer.innerText = `Page ${Math.floor(i/stickersPerPage) + 1} | Generated by Barcode Pro`;
            pageContainer.appendChild(footer);

            document.body.appendChild(pageContainer);
            
            // Render high-quality canvas
            const canvas = await html2canvas(pageContainer, { scale: 3, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            
            pdf.addImage(imgData, 'PNG', 0, 0, pw, (canvas.height * pw) / canvas.width);
            
            document.body.removeChild(pageContainer);
        }

        pdf.save("Barcode_Composer_Report.pdf");
    }
</script>

</body>
</html>
